extends ../../layouts/master.pug

block csslib
	link(href='/cms-static/admin/assets/plugins/custom/datatables/datatables.bundle.css' rel='stylesheet' type='text/css')
	link(href='/cms-static/admin/assets/plugins/custom/jstree/jstree.bundle.css' rel='stylesheet' type='text/css')

block jslib
	// begin::Vendors Javascript(used by this page)
	script(src='/cms-static/admin/assets/plugins/custom/datatables/datatables.bundle.js')
	// end::Vendors Javascript
	// begin::Custom Javascript(used by this page)
	//- script(src='https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js')
	script(src='https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.js')
	script(src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.10/clipboard.min.js")
	script(src='/cms-static/admin/assets/js/custom/apps/ecommerce/catalog/products.js')
	script(src='/cms-static/admin/assets/js/widgets.bundle.js')
	script(src='/cms-static/admin/assets/js/custom/widgets.js')
	script(src='/cms-static/admin/assets/js/custom/apps/chat/chat.js')
	script(src='/cms-static/admin/assets/js/custom/utilities/modals/upgrade-plan.js')
	script(src='/cms-static/admin/assets/js/custom/utilities/modals/create-app.js')
	script(src='/cms-static/admin/assets/js/custom/utilities/modals/users-search.js')
	script(src='/cms-static/admin/assets/plugins/custom/jstree/jstree.bundle.js')

	// Form Submission Script
	script(src='/cms-static/common/js/form-data-json.min.js')
	script(src='/cms-static/common/js/es-form.js')

block customScript
	script.
		// set the dropzone container id
		const id = "#media_queue_uploader";
		const dropzone = document.querySelector(id);
		// set the preview element template
		var previewNode = dropzone.querySelector(".dropzone-item");
		previewNode.id = "";
		var previewTemplate = previewNode.parentNode.innerHTML;
		previewNode.parentNode.removeChild(previewNode);
		var myDropzone = new Dropzone(id, {
		// Make the whole body a dropzone
		url: "/admin/cms/media/upload", // Set the url for your upload script location
		parallelUploads: 20,
		previewTemplate: previewTemplate,
		maxFilesize: 1, // Max filesize in MB
		autoQueue: false, // Make sure the files aren't queued until manually added
		previewsContainer: id + " .dropzone-items", // Define the container to display the previews
		clickable: id + " .dropzone-select", // Define the element that should be used as click trigger to select files.
		});
		myDropzone.on("addedfile", function (file) {
		// Hookup the start button
		file.previewElement.querySelector(id + " .dropzone-start").onclick =
		function () {
		myDropzone.enqueueFile(file);
		};
		const dropzoneItems = dropzone.querySelectorAll(".dropzone-item");
		dropzoneItems.forEach((dropzoneItem) => {
		dropzoneItem.style.display = "";
		});
		dropzone.querySelector(".dropzone-upload").style.display =
		"inline-block";
		dropzone.querySelector(".dropzone-remove-all").style.display =
		"inline-block";
		});
		// Update the total progress bar
		myDropzone.on("totaluploadprogress", function (progress) {
		const progressBars = dropzone.querySelectorAll(".progress-bar");
		progressBars.forEach((progressBar) => {
		progressBar.style.width = progress + "%";
		});
		});
		myDropzone.on("sending", function (file) {
		// Show the total progress bar when upload starts
		const progressBars = dropzone.querySelectorAll(".progress-bar");
		progressBars.forEach((progressBar) => {
		progressBar.style.opacity = "1";
		});
		// And disable the start button
		file.previewElement
		.querySelector(id + " .dropzone-start")
		.setAttribute("disabled", "disabled");
		});
		// Hide the total progress bar when nothing's uploading anymore
		myDropzone.on("complete", function (progress) {
			//- console.log(progress.status)
			if(progress.status == 'success') {
			location.reload()
			}
		const progressBars = dropzone.querySelectorAll(".dz-complete");
		setTimeout(function () {
		progressBars.forEach((progressBar) => {
		progressBar.querySelector(".progress-bar").style.opacity = "0";
		progressBar.querySelector(".progress").style.opacity = "0";
		progressBar.querySelector(".dropzone-start").style.opacity = "0";
		});
		}, 300);
		});
		// Setup the buttons for all transfers
		dropzone
		.querySelector(".dropzone-upload")
		.addEventListener("click", function () {
		myDropzone.enqueueFiles(
		myDropzone.getFilesWithStatus(Dropzone.ADDED)
		);
		});
		// Setup the button for remove all files
		dropzone
		.querySelector(".dropzone-remove-all")
		.addEventListener("click", function () {
		dropzone.querySelector(".dropzone-upload").style.display = "none";
		dropzone.querySelector(".dropzone-remove-all").style.display = "none";
		myDropzone.removeAllFiles(true);
		});
		// On all files completed upload
		myDropzone.on("queuecomplete", function (progress) {
		const uploadIcons = dropzone.querySelectorAll(".dropzone-upload");
		uploadIcons.forEach((uploadIcon) => {
		uploadIcon.style.display = "none";
		});
		});
		// On all files removed
		myDropzone.on("removedfile", function (file) {
		if (myDropzone.files.length < 1) {
		dropzone.querySelector(".dropzone-upload").style.display = "none";
		dropzone.querySelector(".dropzone-remove-all").style.display = "none";
		}
		});

	script.
		let images = document.querySelectorAll(".lazy");
		new LazyLoad(images);

		let buttons = document.querySelectorAll(".copy-btn");
		var clipboard = new ClipboardJS(buttons)
		clipboard.on('success', function (e) {
			navigator.clipboard.writeText(e.text)
			const Toast = Swal.mixin({
				toast: true,
				position: 'top-end',
				showConfirmButton: false,
				timer: 1500,
				timerProgressBar: true,
				didOpen: (toast) => {
					toast.addEventListener('mouseenter', Swal.stopTimer)
					toast.addEventListener('mouseleave', Swal.resumeTimer)
				}
			})
			Toast.fire({
				icon: 'success',
				title: 'URL Copied to clipboard'
			})
			e.clearSelection();
		});

block content
	.d-flex.flex-column.flex-column-fluid
		#kt_app_toolbar.app-toolbar.py-3.py-lg-6
			#kt_app_toolbar_container.app-container.container-xxl.d-flex.flex-stack
				.page-title.d-flex.flex-column.justify-content-center.flex-wrap.me-3
					h1.page-heading.d-flex.text-dark.fw-bold.fs-3.flex-column.justify-content-center.my-0
						| Media Management
					ul.breadcrumb.breadcrumb-separatorless.fw-semibold.fs-7.my-0.pt-1
						li.breadcrumb-item.text-muted
							a.text-muted.text-hover-primary(href='/admin/dashboard') Home
						li.breadcrumb-item
							span.bullet.bg-gray-400.w-5px.h-2px
						li.breadcrumb-item.text-muted CMS
						li.breadcrumb-item
							span.bullet.bg-gray-400.w-5px.h-2px
						li.breadcrumb-item.text-muted Media
				.d-flex.align-items-center.gap-2.gap-lg-3
					a.btn.btn-sm.fw-bold.btn-primary(href='#' data-bs-toggle='modal' data-bs-target='#media_uploader_modal') Upload Media

		#kt_app_content.app-content.flex-column-fluid
			#kt_app_content_container.app-container.container
				.row.g-5.g-10.mb-10
					.col-12.col-md-8.mx-auto.my-5.border.border-primary.border-active.active
						form.form(action='#' method='post')
							.form-group.row
								label.col-lg-2.col-form-label.text-lg-right Upload Files:
								.col-lg-10
									#media_queue_uploader.dropzone.dropzone-queue.mb-2
										.dropzone-panel.mb-lg-0.mb-2
											a.dropzone-select.btn.btn-sm.btn-primary.me-2 Attach files
											a.dropzone-upload.btn.btn-sm.btn-light-primary.me-2 Upload All
											a.dropzone-remove-all.btn.btn-sm.btn-light-primary Remove All
										.dropzone-items.wm-200px
											.dropzone-item(style='display:none')
												.dropzone-file
													.dropzone-filename(title='some_image_file_name.jpg')
														span(data-dz-name='') some_image_file_name.jpg
														strong
															| (
															span(data-dz-size='') 340kb
															| )
													.dropzone-error(data-dz-errormessage='')
												.dropzone-progress
													.progress
														.progress-bar.bg-primary(role='progressbar' aria-valuemin='0' aria-valuemax='100' aria-valuenow='0' data-dz-uploadprogress='')
												.dropzone-toolbar
													span.dropzone-start
														i.bi.bi-play-fill.fs-3
													span.dropzone-cancel(data-dz-remove='' style='display: none;')
														i.bi.bi-x.fs-3
													span.dropzone-delete(data-dz-remove='')
														i.bi.bi-x.fs-1
									span.form-text.text-muted Max file size is 1MB and max number of files is 5.


				.row.g-5.g-10.mb-10
					each item,i in media
						input(id=`img-${i}` value=`${item.url}` hidden)
						.col-12.col-sm-4.col-md-3.col-lg-2.col-xl-2.col-xxl-2.text-center
							.mb-2.mb-xl-2.copy-btn(data-clipboard-target=`#img-${i}` data-bs-toggle="tooltip" data-bs-placement="top" title="Click to copy Image URL")
								img.lazy.img-thumbnail.ursor-pointer(src="/admin/assets/media/svg/files/blank-image.svg" data-src=`${item.url}` alt="image", srcset="" style="width: 120px; height: 120px; object-fit: cover;")
					else
						.text-center 
							h4.mt-10 No images available


