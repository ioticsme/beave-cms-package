{% extends "../../layouts/master.njk" %}

{% block csslib %}
	<link href='/cms-static/admin/assets/plugins/custom/datatables/datatables.bundle.css' rel='stylesheet' type='text/css'/>
	<link href='/cms-static/admin/assets/plugins/custom/jstree/jstree.bundle.css' rel='stylesheet' type='text/css'/>
{% endblock %}

{% block jslib %}
	<!-- begin::Vendors Javascript(used by this page)
	<script src="/cms-static/admin/assets/plugins/custom/datatables/datatables.bundle.js"></script>
	end::Vendors Javascript-->
	<!-- begin::Custom Javascript(used by this page)-->
	<script src="/cms-static/admin/assets/js/custom/apps/ecommerce/catalog/products.js"></script>
	<script src="/cms-static/admin/assets/js/custom/utilities/modals/create-app.js"></script>
	<script src="/cms-static/admin/assets/js/custom/utilities/modals/users-search.js"></script>
	<script src="/cms-static/admin/assets/plugins/custom/jstree/jstree.bundle.js"></script>
	<!-- Form Submission Script-->
	<script src="/cms-static/common/js/form-data-json.min.js"></script>
	<script src="/cms-static/common/js/es-form.js"></script>
{% endblock %}

{% block customScript %}
	<script>
		$(".jstree_dragdrop").jstree({
			"core": {
				"themes": {
					"responsive": false
				},
				// so that create works
				"check_callback": true
			},
			"types": {
				"default": {
					"icon": "fa fa-folder text-success",
					"max_children": 10,
					"max_depth": 2
				},
				"file": {
					"icon": "fa fa-file  text-success"
				}
			},
			"state": {
				"key": "demo2"
			},
			"plugins": ["dnd", "state", "types"]
		});

		function saveMenuSorting(treeData, name) {
			const data = {
				'menu': treeData,
				name
			}
			axios
				.post('/admin/cms/menu/save', data)
				.then(async function (res) {
					location.reload()
				})
				.catch(function (error) {
					console.log(error);
				});
		}

		function deleteMenuItem(item) {
			const id = item.getAttribute('id')
			const nav_position = item.getAttribute('nav_position')
			const level = item.getAttribute('level')
			const obj = {
				id,
				nav_position,
				level
			}
			Swal
				.fire({
					text: 'Are you sure you want to delete ?',
					icon: 'warning',
					showCancelButton: !0,
					buttonsStyling: !1,
					confirmButtonText: 'Yes, delete!',
					cancelButtonText: 'No, cancel',
					customClass: {
						confirmButton: 'btn fw-bold btn-danger',
						cancelButton: 'btn fw-bold btn-active-light-primary'
					}
				})
				.then((e) => {
					if (e.value) {
						axios
							.post('/admin/cms/menu/delete', obj)
							.then((res) => {
								let data = res
									.data
									Swal
									.fire({
										text: data.message || 'You have deleted  !.',
										icon: 'success',
										buttonsStyling: !1,
										confirmButtonText: 'Ok',
										customClass: {
											confirmButton: 'btn fw-bold btn-primary'
										}
									})
									.then(() => {
										location.reload()
									})
							})
							.catch((error) => {
								let data = error?.response?.data
								Swal.fire({
									text: data.error || 'Something went wrong !.',
									icon: 'warning',
									buttonsStyling: !1,
									confirmButtonText: 'Ok, got it!',
									customClass: {
										confirmButton: 'btn fw-bold btn-primary'
									}
								})
							})
						}
				})
		}

		function editMenu(item) {
			let url = item.getAttribute('href')
			location.href = url
		}

		$(".jstree_dragdrop")
			.on("redraw.jstree", function (e, data) {
				console.log(e.target.getAttribute("data-nav_position"))
				const targetId = e.target.id
				const menuName = e
					.target
					.getAttribute("data-nav_position")
				var v = $(`#${targetId}`)
					.jstree(true)
					.get_json('#', {flat: true})
				var redrawData = JSON.stringify(v);
				saveMenuSorting(redrawData, menuName)
			})
			.jstree();
	</script>
{% endblock %}

{% block content %}
	<div class="d-flex flex-column flex-column-fluid">
		<div class="app-toolbar py-3 py-lg-6" id="kt_app_toolbar">
			<div class="app-container container-xxl d-flex flex-stack" id="kt_app_toolbar_container">
				<div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
					<h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">Menu Management</h1>
					<ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
						<li class="breadcrumb-item text-muted">
							<a class="text-muted text-hover-primary" href="/admin/dashboard">Home</a>
						</li>
						<li class="breadcrumb-item">
							<span class="bullet bg-gray-400 w-5px h-2px"></span></li>
						<li class="breadcrumb-item text-muted">CMS</li>
						<li class="breadcrumb-item">
							<span class="bullet bg-gray-400 w-5px h-2px"></span></li>
						<li class="breadcrumb-item text-muted">Menu</li>
					</ul>
				</div>
				<div class="d-flex align-items-center gap-2 gap-lg-3">
					<a class="btn btn-sm fw-bold btn-primary" href="#" data-bs-toggle="modal" data-bs-target="#kt_modal_create_app">Add New</a>
				</div>
			</div>
		</div>
		<div id="kt_app_content" class="app-content flex-column-fluid">
			<div id="kt_app_content_container" class="app-container container">
				<div class="row g-5">
					{% for nav in menulist %}
						<div class="col-lg-6">
							<div class="card card-stretch card-bordered mb-5">
								<div class="card-header">
									<h3 class="card-title">{{ nav.nav_label }}</h3>
								</div>
								<div class="card-body">
									<div class="jstree_dragdrop" id="nav_{{ nav.nav_position }}" data-nav_position="{{ nav.nav_position }}">
										<ul>
											{% for menu in nav.nav_items %}
												<li data-id="{{ menu._id }}" url="{{ menu.url }}" label="{{ menu.label }}">{{ menu.label.en }}
													<button id="{{ menu._id }}" nav_position="{{ nav.nav_position }}" level="0" onClick="deleteMenuItem(this)">
														<i class="fa-solid fa-trash text-danger"></i>
													</button>
													<button id="{{ menu._id }}" nav_position="{{ nav.nav_position }}" level="0" href="/admin/cms/menu/{{ nav.nav_position }}/edit/{{ menu._id }}/0" onClick="editMenu(this)">
														<i class="fa-solid fa-pen text-primary"></i>
													</button>

													<ul>
														{% for first_level_child in menu.child %}
															<li data-id="{{ first_level_child._id }}" url={{ first_level_child.url }} label={{ first_level_child.label }}>{{ first_level_child.label.en }}
																<button id="{{ first_level_child._id }}" nav_position="{{ nav.nav_position }}" level="1" onClick="deleteMenuItem(this)">
																	<i class="fa-solid fa-trash text-danger"></i>
																</button>
																<button id="{{ menu._id }}" nav_position="{{ nav.nav_position }}" level="0" href="/admin/cms/menu/{{ nav.nav_position }}/edit/{{ first_level_child._id }}/1?parent_index={{ loop.index }}" onClick="editMenu(this)">
																	<i class="fa-solid fa-pen text-primary"></i>
																</button>

																<ul>
																	{% for second_level_child in first_level_child.child %}
																		<li data-id="{{ second_level_child._id }}" url="{{ second_level_child.url }}" label="{{ second_level_child.label }}">{{ second_level_child.label.en }}
																			<button id="{{ second_level_child._id }}" nav_position="{{ nav.nav_position }}" level="2" onClick="deleteMenuItem(this)">
																				<i class="fa-solid fa-trash text-danger"></i>
																			</button>
																			<button id="{{ menu._id }}" nav_position="{{ nav.nav_position }}" level="0" href="/admin/cms/menu/{{ nav.nav_position }}/edit/{{ second_level_child._id }}/2?parent_index={{ loop.index }}&sec_parent_index={{ loop.parent.loop.index }}" onClick="editMenu(this)">
																				<i class="fa-solid fa-pen text-primary"></i>
																			</button>
																		</li>
																	{% endfor %}
																</ul>
															</li>
														{% endfor %}
													</ul>
												</li>
											{% endfor %}
										</ul>
									</div>
								</div>
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
		</div>

		<div class="modal fade" id="kt_modal_create_app" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered mw-900px">
				<div class="modal-content">
					<div class="modal-header">
						<h2>Add Menu</h2>
						<div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
							<h3>X</h3>
						</div>
					</div>
					<div class="modal-body py-lg-10 px-lg-10">
						<form class="form es-form" id="kt_modal_create_app_form" action="/admin/cms/menu/add" data-kt-redirect-url="/admin/cms/menu" method="post">
							<div class="card card-flush">
								<div class="card-body pt-0">
									<div class="col-md-6">
										<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
											<span class="required">Menu Position</span>
											<i class="fas fa-exclamation-circle ms-2 fs-7" data-bs-toggle="tooltip" aria-label="path" data-kt-initialized="1"></i>
										</label>
										<select id="kt_ecommerce_add_product_status_select" class="form-select mb-2" name="menu_position">
											<option value="" "selected"> -- Choose Nav Position -- </option>
											{% for nav in menulist %}
												<option value="{{ nav.nav_position }}">{{ nav.nav_label }}</option>
											{% endfor %}
										</select>
										<pre>--OR--</pre>
										<input type="text" class="form-control mb-2" name="menu_position_new" placeholder="New Menu Position" value="">
										<div class="fv-plugins-message-container invalid-feedback" id="field-error-menu_position"></div>
										<div class="fv-plugins-message-container invalid-feedback" id="field-error-menu_position_new"></div>
										<ul class="nav nav-tabs nav-line-tabs mb-5 fs-6">
											{% for brandLanguage in authUser.brand.languages %}
												<li class="nav-item">
													<a class="nav-link {{ 'active' if loop.index == 1 }}" data-bs-toggle="tab" href="#kt_tab_pane_{{ brandLanguage.prefix }}">{{ brandLanguage.name }}</a>
												</li>
											{% endfor %}
										</ul>
									</div>

									<div class="tab-content tab-content-fields" id="myTabContent">
										{% for brandLanguage in authUser.brand.languages %}
											<div class="tab-pane fade {{ 'active show' if loop.index == 1 }}" role="tabpanel" id="kt_tab_pane_{{ brandLanguage.prefix }}">
												<div class="d-flex flex-column fv-row fv-plugins-icon-container col-md-6">
													<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
														<span class="required"> Menu name ({{ brandLanguage.prefix }}) </span>
														<i class="fas fa-exclamation-circle ms-2 fs-7" data-bs-toggle="tooltip" aria-label="label" data-kt-initialized="1"></i>
													</label>
													<input type="text" class="form-control mb-2" name="label[{{ brandLanguage.prefix }}]" placeholder="Menu label" value="">
													<div class="fv-plugins-message-container invalid-feedback" id="field-error-label_{{ brandLanguage.prefix }}"></div>
												</div>
												<div class="col-md-6">
													<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
														<span class="required"> Path ({{ brandLanguage.prefix }}) </span>
														<i class="fas fa-exclamation-circle ms-2 fs-7" data-bs-toggle="tooltip" aria-label="path" data-kt-initialized="1"></i>
													</label>
													<input type="text" class="form-control mb-2" name="path[{{ brandLanguage.prefix }}]" placeholder="Menu path url" value="">
													<div class="fv-plugins-message-container invalid-feedback" id="field-error-path_{{ brandLanguage.prefix }}"></div>
												</div>
											</div>
										{% endfor %}
									</div>
									<div class="col-md-6">
										<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
											<span>Link Type</span>
											<i class="fas fa-exclamation-circle ms-2 fs-7" data-bs-toggle="tooltip" aria-label="path" data-kt-initialized="1"></i>
										</label>
										<div class="form-check form-check-custom form-check-solid">
											<input id="flexCheckChecked" class="form-check-input" type="checkbox" name="external" value="true"/>
											<label class="form-check-label" for="flexCheckChecked">External</label>
										</div>

										<div class="card-toolbar mt-8 d-flex justify-content-end">
											<button class="btn btn-sm btn-success form-submit-btn" type="submit">
												<span class="label">Save</span>
												<span class="preloader d-none">Saving...</span>
											</button>
										</div>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

{% endblock %}