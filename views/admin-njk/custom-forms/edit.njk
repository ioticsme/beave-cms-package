{% extends "../../layouts/master.njk" %}

{% block csslib %}
	<link href="/cms-static/admin/assets/plugins/custom/fullcalendar/fullcalendar.bundle.css" rel="stylesheet" type="text/css"/>
	<link href='/cms-static/admin/assets/plugins/custom/datatables/datatables.bundle.css' rel='stylesheet' type='text/css'/>
	<link href='/cms-static/admin/assets/plugins/global/plugins.bundle.css' rel='stylesheet' type='text/css'/>
	<link href='/cms-static/admin/assets/css/style.bundle.css' rel='stylesheet' type='text/css'/>
{% endblock %}

{% block jslib %}
	{# // begin::Vendors Javascript(used by this page) #}
	{# //- script(src='/cms-static/admin/assets/plugins/custom/fullcalendar/fullcalendar.bundle.js') #}
	<script src='/cms-static/admin/assets/plugins/custom/datatables/datatables.bundle.js'></script>
	{# // end::Vendors Javascript #}
	{# // begin::Custom Javascript(used by this page) #}
	{# //- script(src='/cms-static/admin/assets/js/custom/apps/subscriptions/add/advanced.js') #}
	{# //- script(src='/cms-static/admin/assets/js/custom/apps/subscriptions/add/customer-select.js') #}
	{# //- script(src='/cms-static/admin/assets/js/custom/apps/subscriptions/add/products.js') #}
	{# //- script(src='/cms-static/admin/assets/js/widgets.bundle.js') #}
	{# //- script(src='/cms-static/admin/assets/js/custom/widgets.js') #}
	{# //- script(src='/cms-static/admin/assets/js/custom/apps/ecommerce/sales/save-order.js') #}
	{# //- script(src='/cms-static/admin/assets/js/custom/utilities/modals/create-app.js') #}
	{# //- script(src='/cms-static/admin/assets/js/custom/utilities/modals/new-card.js') #}
	{# //- script(src='/cms-static/admin/assets/js/custom/utilities/modals/users-search.js') #}
	{# // end::Custom Javascript #}

	{# // CKEditor Build Bundles #}
	<script src='/cms-static/admin/assets/plugins/custom/ckeditor/ckeditor-classic.bundle.js'></script>

	<script src='/cms-static/admin/assets/js/scripts.bundle.js'></script>

	{# // Form Submission Script #}
	<script src='/cms-static/common/js/form-data-json.min.js'></script>
	<script src='/cms-static/common/js/es-form.js'></script>

	{# //- custom functions  #}
	<script src='/cms-static/common/js/custom-functions.js'></script>
{% endblock %}

{% block customScript %}
	<script>
		document
			.querySelectorAll('.content_wysiwyg')
			.forEach(function (e) {
				ClassicEditor
					.create(document.querySelector(`#${e.getAttribute('id')}`))
					.then(editor => {})
					.catch(error => {
						console.error(error);
					});
			})

		document
			.querySelectorAll('.kt_daterangepicker input')
			.forEach((picker) => {
				$(`#${picker.id}`).flatpickr({
					altInput: !0,
					altFormat: 'd F, Y',
					dateFormat: 'Y-m-dTH:i:00.000\\Z'
				})
			})

		document
			.querySelectorAll('[data-cf-control="select2"] ')
			.forEach((item) => {
				$(item).select2()
			})

		var childIndex = 0
		function cloneChild() {
			let cf = document
				.querySelector("input[name='custom_fields']")
				.value
			let cfLength = childIndex
			if (cf.length) {
				let customFields = JSON.parse(cf)
					?.custom_fields
				let customFieldsLength = customFields
					?.length
				cfLength = childIndex + customFieldsLength
			}
			childIndex++
			let p = document.querySelector(".cf-card")
			let p_prime = p.cloneNode(true)
			let newElement = document
				.getElementById('form-holder')
				.appendChild(p_prime)
			newElement.setAttribute("id", "cf-card-" + cfLength) //setting ID for newly created card
			//- document.querySelector(`#cf-card-${cfLength} .title`).textContent = `Custom Field ${cfLength + 1}`
			document
				.querySelectorAll(`#cf-card-${cfLength} .cf `)
				.forEach(function (element) {
					if (element.type == 'select-one') {} else if (element.type == 'text') {
						element.value = null
					}
				})
			document
				.querySelectorAll(`#cf-card-${cfLength} .fv-plugins-message-container `)
				.forEach(function (element) {
					let id = element
						.id
						.split('_')
					id.pop()
					let newId = id.join('_')
					element.setAttribute('id', `${newId}_${cfLength}`)
				})

			document
				.querySelectorAll(` [data-cf-control="select2"] `)
				.forEach((item) => {
					$(item).select2()
				})

		}
	</script>
{% endblock %}

{% block content %}
	<div class="d-flex flex-column flex-column-fluid">
		<div class="app-toolbar py-3 py-lg-6" id="kt_app_toolbar">
			<div class="app-container container-xxl d-flex flex-stack" id="kt_app_toolbar_container">
				<div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
					<h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">Create New Form</h1>
					<ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
						<li class="breadcrumb-item text-muted">
							<a class="text-muted text-hover-primary" href="/admin/custom-forms">Form</a>
						</li>
						<li class="breadcrumb-item">
							<span class="bullet bg-gray-400 w-5px h-2px"></span></li>
						<li class="breadcrumb-item text-muted">Add New</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="app-content flex-column-fluid" id="kt_app_content">
			<div class="app-container container-xxl" id="kt_app_content_container">
				<div class="d-flex flex-column flex-lg-row">
					<div class="flex-lg-row-fluid me-lg-15 order-2 order-lg-1 mb-10 mb-lg-0">
						<form class="form es-form" id="kt_subscriptions_create_new" action="/admin/custom-forms/save" data-kt-redirect-url="/admin/custom-forms" method="post">
							<input type="hidden" name="id" value={{ form.id }}/>
							<input type="hidden" name="custom_fields" value={{ JSON.stringify(form || {}) }}/>
							<div class="card card-flush pt-3 mb-5 mb-lg-10">
								<div class="card-header">
									<div class="card-title">
										<h2 class="fw-bold">Form Basic Info</h2>
									</div>
									<div class="card-toolbar">
										<button class="btn btn-sm btn-success form-submit-btn" type="submit">
											<span class="label">Save</span>
											<span class="preloader d-none">Saving...</span></button>
									</div>
								</div>
								<div class="card-body pt-0" id="form-holder">
									<div class="row">
										<div class="d-flex flex-column mb-8 fv-row fv-plugins-icon-container col-md-4">
											<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
												<span class="required">Form Name</span>
											</label>
											<input class="form-control" type="text" placeholder="Enter Form Name" value="{{ form.form_name }}" name="form_name">
											<div class="fv-plugins-message-container invalid-feedback" id="field-error-form_name"></div>
										</div>
										<div class="d-flex flex-column fv-row fv-plugins-icon-container col-md-4">
											<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
												<span class="required">Auto Reply Email Template</span>
											</label>
											<select class="cf kt_field_type_select form-select mb-2" data-cf-control="select" data-hide-search="true" data-placeholder="Select a type" name="reply_email_template">
												<option value="">Select an option</option>
												{% for item in domainTemplates.items %}
													<option value="{{ item.name }}" {% if item.name == form.reply_email_template %}selected{% endif %}>{{ item.name }}</option>
												{% endfor %}
											</select>
											<div class="fv-plugins-message-container invalid-feedback" id="field-error-reply_email_template"></div>
										</div>
										<div class="d-flex flex-column mb-8 fv-row fv-plugins-icon-container col-md-4 pt-10">
											<div class="form-check form-check-custom form-check-success form-check-solid">
												<input class="form-check-input" type="checkbox" value="true" {% if form.has_captcha %}checked{% endif %}>
												<label class="form-check-label" for="">
												Google Captcha
											</label>
											</div>
										</div>
									</div>

									<h3>Notification</h3>
									<div class="row">
										<div class="d-flex flex-column mb-8 fv-row fv-plugins-icon-container col-md-6">
											<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
												<span class="required">Email Form Data To:</span>
											</label>
											<input type="text" class="form-control" placeholder="Enter Form Name" value={{ form.recepient_emails }} name="form_name">
											<div class="fv-plugins-message-container invalid-feedback" id="field-error-form_name"></div>
										</div>
										<div class="d-flex flex-column fv-row fv-plugins-icon-container col-md-6">
											<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
												<span class="required">Email Template</span>
											</label>
											<select class="cf kt_field_type_select form-select mb-2" data-cf-control="select" data-hide-search="true" data-placeholder="Select a type" name="recepient_email_template">
												<option value="">Select an option</option>
												{% for item in domainTemplates.items %}
													<option value="{{ item.name }}" {% if item.name == form.recepient_email_template %}selected{% endif %}>{{ item.name }}</option>
												{% endfor %}
											</select>
											<div class="fv-plugins-message-container invalid-feedback" id="field-error-recepient_email_template"></div>
										</div>
										<div class="d-flex flex-column mb-8 fv-row fv-plugins-icon-container col-md-12">
											<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
												<span class="required">Slack URL</span>
											</label>
											<input type="text" class="form-control" placeholder="Enter Form Name" value={{ form.slack_url }} name="form_name">
											<div class="fv-plugins-message-container invalid-feedback" id="field-error-form_name"></div>
										</div>
									</div>

									<h3>Fields</h3>
									{% if form and form.custom_fields %}
										{% for item, i in form.custom_fields %}
											<div class="row cf-card mt-2">
												<div class="d-flex flex-column fv-row fv-plugins-icon-container col-md-6">
													<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
														<span class="required">Field Name</span>
													</label>
													<input type="text" class="form-control cf" placeholder="Enter field name" value="{{ item.field_name }}" name="field_name[]">
													<div id="field-error-field_name_{{ i }}" class="fv-plugins-message-container invalid-feedback"></div>
												</div>
												<div class="d-flex flex-column fv-row fv-plugins-icon-container col-md-6">
													<label class="d-flex align-items-center fs-6 fw-semibold mb-2">
														<span class="required">Field Validation</span>
													</label>
													<input type="text" class="form-control cf" placeholder="Enter field name" value="{{ item.validation }}" name="field_validation[]">
													<div id="field-error-field_validation_{{ i }}" class="fv-plugins-message-container invalid-feedback"></div>
												</div>
											</div>
										{% endfor %}
									{% endif %}
								</div>
								<div class="text-center">
									<div class="btn btn-primary btn-sm mb-5" onClick="cloneChild()">Add New Field</div>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

{% endblock %}